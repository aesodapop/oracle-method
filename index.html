<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oracle Method ‚Äî Buffett-Grade Stock Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=IBM+Plex+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a08;
  --bg2: #111110;
  --bg3: #1a1a18;
  --border: #2a2a26;
  --gold: #c9a84c;
  --gold2: #e8c96a;
  --amber: #d4752a;
  --green: #4a9e6b;
  --red: #c0392b;
  --yellow: #d4a017;
  --text: #e8e4d8;
  --text2: #9a9688;
  --text3: #5a5850;
  --mono: 'IBM Plex Mono', monospace;
  --serif: 'Playfair Display', serif;
  --sans: 'IBM Plex Sans', sans-serif;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  font-size: 14px;
  min-height: 100vh;
  overflow-x: hidden;
}

/* Subtle grain texture */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 9999;
  opacity: 0.4;
}

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 32px;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 100;
}

.logo {
  display: flex;
  align-items: baseline;
  gap: 12px;
}

.logo-title {
  font-family: var(--serif);
  font-size: 22px;
  font-weight: 900;
  color: var(--gold);
  letter-spacing: -0.5px;
}

.logo-sub {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  letter-spacing: 2px;
  text-transform: uppercase;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

/* Search */
.search-bar {
  display: flex;
  align-items: center;
  gap: 0;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 4px;
  overflow: hidden;
  transition: border-color 0.2s;
}
.search-bar:focus-within { border-color: var(--gold); }

.search-input {
  background: none;
  border: none;
  outline: none;
  color: var(--text);
  font-family: var(--mono);
  font-size: 14px;
  padding: 9px 14px;
  width: 160px;
  letter-spacing: 1px;
  text-transform: uppercase;
}
.search-input::placeholder { color: var(--text3); text-transform: uppercase; }

.search-btn {
  background: var(--gold);
  border: none;
  color: #000;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 1px;
  padding: 10px 16px;
  cursor: pointer;
  text-transform: uppercase;
  transition: background 0.2s;
}
.search-btn:hover { background: var(--gold2); }

/* Watchlist button */
.watchlist-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text2);
  font-family: var(--mono);
  font-size: 11px;
  padding: 9px 14px;
  cursor: pointer;
  letter-spacing: 1px;
  border-radius: 4px;
  transition: all 0.2s;
}
.watchlist-btn:hover { border-color: var(--gold); color: var(--gold); }

/* Layout */
.app {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: calc(100vh - 61px);
}

/* Sidebar */
.sidebar {
  border-right: 1px solid var(--border);
  padding: 24px 20px;
  overflow-y: auto;
  background: var(--bg);
}

.sidebar-section {
  margin-bottom: 28px;
}

.sidebar-label {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 12px;
}

/* Watchlist items */
.watchlist-items {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.wl-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 12px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.15s;
}
.wl-item:hover { border-color: var(--gold); background: #1e1e1a; }
.wl-item.active { border-color: var(--gold); background: #1e1e1a; }

.wl-ticker {
  font-family: var(--mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--gold);
  letter-spacing: 1px;
}

.wl-score {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
}

.wl-remove {
  background: none;
  border: none;
  color: var(--text3);
  cursor: pointer;
  font-size: 14px;
  padding: 0 0 0 8px;
  line-height: 1;
  transition: color 0.2s;
}
.wl-remove:hover { color: var(--red); }

.wl-empty {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  font-style: italic;
  padding: 8px 0;
}

/* Competitor add */
.comp-add {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
}
.comp-input {
  flex: 1;
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  padding: 7px 10px;
  border-radius: 4px;
  outline: none;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.comp-input:focus { border-color: var(--gold); }
.comp-add-btn {
  background: var(--bg3);
  border: 1px solid var(--border);
  color: var(--gold);
  font-family: var(--mono);
  font-size: 13px;
  padding: 7px 12px;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.15s;
}
.comp-add-btn:hover { border-color: var(--gold); background: #1e1e1a; }

.comp-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.comp-tag {
  display: flex;
  align-items: center;
  gap: 6px;
  background: var(--bg3);
  border: 1px solid var(--border);
  padding: 4px 10px;
  border-radius: 20px;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text2);
}
.comp-tag-remove {
  background: none;
  border: none;
  color: var(--text3);
  cursor: pointer;
  font-size: 12px;
  line-height: 1;
}
.comp-tag-remove:hover { color: var(--red); }

/* Main content */
.main {
  overflow-y: auto;
  padding: 0;
}

/* Welcome state */
.welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  padding: 60px 40px;
  text-align: center;
}

.welcome-oracle {
  font-family: var(--serif);
  font-size: 72px;
  font-weight: 900;
  color: var(--gold);
  opacity: 0.15;
  line-height: 1;
  margin-bottom: 24px;
  letter-spacing: -3px;
}

.welcome-title {
  font-family: var(--serif);
  font-size: 28px;
  color: var(--text2);
  margin-bottom: 12px;
}

.welcome-sub {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--text3);
  letter-spacing: 1px;
  line-height: 1.8;
}

/* Ticker header */
.ticker-header {
  padding: 28px 32px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 20px;
  flex-wrap: wrap;
}

.ticker-name {
  font-family: var(--serif);
  font-size: 36px;
  font-weight: 900;
  color: var(--gold);
  letter-spacing: -1px;
  line-height: 1;
}

.ticker-company {
  font-family: var(--sans);
  font-size: 14px;
  color: var(--text2);
  margin-top: 6px;
  font-weight: 300;
}

.ticker-meta {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  margin-top: 4px;
  letter-spacing: 0.5px;
}

/* Score cards */
.score-cards {
  display: flex;
  gap: 16px;
  margin-top: 16px;
}

.score-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 14px 20px;
  min-width: 120px;
}

.score-label {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 6px;
}

.score-value {
  font-family: var(--serif);
  font-size: 36px;
  font-weight: 900;
  line-height: 1;
}

.score-value.high { color: var(--green); }
.score-value.mid { color: var(--yellow); }
.score-value.low { color: var(--red); }

.score-bar {
  width: 80px;
  height: 3px;
  background: var(--border);
  border-radius: 2px;
  margin-top: 8px;
  overflow: hidden;
}
.score-bar-fill {
  height: 100%;
  border-radius: 2px;
  background: var(--green);
  transition: width 1s ease;
}

/* Tabs */
.tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  padding: 0 32px;
  background: var(--bg);
  position: sticky;
  top: 0;
  z-index: 50;
}

.tab {
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text3);
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: all 0.2s;
  white-space: nowrap;
}
.tab:hover { color: var(--text2); }
.tab.active { color: var(--gold); border-bottom-color: var(--gold); }

/* Tab content */
.tab-content {
  padding: 24px 32px;
  display: none;
}
.tab-content.active { display: block; }

/* Section headers */
.section-title {
  font-family: var(--serif);
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-title::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

/* Metrics grid */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
  margin-bottom: 28px;
}

.metric-card {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 14px 16px;
}

.metric-name {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 8px;
}

.metric-val {
  font-family: var(--mono);
  font-size: 18px;
  font-weight: 500;
  color: var(--text);
}

.metric-trend {
  font-family: var(--mono);
  font-size: 10px;
  margin-top: 4px;
}
.metric-trend.up { color: var(--green); }
.metric-trend.down { color: var(--red); }
.metric-trend.flat { color: var(--text3); }

/* Charts */
.chart-container {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 20px;
  margin-bottom: 20px;
}

.chart-title {
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.debt-flag {
  font-size: 9px;
  background: rgba(192,57,43,0.15);
  border: 1px solid rgba(192,57,43,0.4);
  color: var(--red);
  padding: 2px 8px;
  border-radius: 10px;
  letter-spacing: 1px;
}

.bar-chart {
  display: flex;
  align-items: flex-end;
  gap: 6px;
  height: 120px;
  padding-bottom: 24px;
  position: relative;
}

.bar-col {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  position: relative;
}

.bar {
  width: 100%;
  border-radius: 2px 2px 0 0;
  transition: height 0.8s ease;
  position: absolute;
  bottom: 20px;
  cursor: default;
  min-height: 2px;
}
.bar:hover { opacity: 0.8; }

.bar-label {
  position: absolute;
  bottom: 2px;
  font-family: var(--mono);
  font-size: 9px;
  color: var(--text3);
  white-space: nowrap;
}

.bar-val {
  position: absolute;
  top: -16px;
  font-family: var(--mono);
  font-size: 8px;
  color: var(--text2);
  white-space: nowrap;
}

.bar.revenue { background: var(--gold); }
.bar.income { background: var(--green); }
.bar.income.negative { background: var(--red); }
.bar.cashflow { background: #5b8fc7; }
.bar.debt { background: var(--amber); }
.bar.debt.flagged { background: var(--red); border: 1px solid rgba(255,255,255,0.3); }

/* Buffett scores breakdown */
.score-breakdown {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 28px;
}

.score-breakdown-card {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 20px;
}

.score-breakdown-title {
  font-family: var(--serif);
  font-size: 15px;
  color: var(--gold);
  margin-bottom: 16px;
  font-weight: 700;
}

.score-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid var(--border);
}
.score-row:last-child { border-bottom: none; }

.score-row-label {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text2);
}

.score-row-val {
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
}
.score-row-val.good { color: var(--green); }
.score-row-val.warn { color: var(--yellow); }
.score-row-val.bad { color: var(--red); }

/* AI narrative */
.ai-narrative {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-left: 3px solid var(--gold);
  border-radius: 6px;
  padding: 20px;
  margin-bottom: 20px;
}

.ai-narrative-title {
  font-family: var(--mono);
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 12px;
}

.ai-narrative-text {
  font-family: var(--sans);
  font-size: 13px;
  color: var(--text);
  line-height: 1.7;
}

/* Filing items */
.filing-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.filing-item {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 14px 16px;
  cursor: pointer;
  transition: border-color 0.15s;
}
.filing-item:hover { border-color: var(--gold); }

.filing-header {
  display: flex;
  align-items: center;
  gap: 12px;
}

.filing-type {
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 500;
  padding: 3px 8px;
  border-radius: 3px;
  letter-spacing: 1px;
}
.filing-type.tenk { background: rgba(74,158,107,0.15); color: var(--green); border: 1px solid rgba(74,158,107,0.3); }
.filing-type.tenq { background: rgba(91,143,199,0.15); color: #5b8fc7; border: 1px solid rgba(91,143,199,0.3); }
.filing-type.def14a { background: rgba(212,117,42,0.15); color: var(--amber); border: 1px solid rgba(212,117,42,0.3); }
.filing-type.eightk { background: rgba(201,168,76,0.15); color: var(--gold); border: 1px solid rgba(201,168,76,0.3); }

.filing-desc {
  font-family: var(--sans);
  font-size: 12px;
  color: var(--text2);
  flex: 1;
}

.filing-date {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
}

.filing-link {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--gold);
  text-decoration: none;
  letter-spacing: 0.5px;
}
.filing-link:hover { color: var(--gold2); }

/* Filing narrative */
.filing-narrative {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
  font-family: var(--sans);
  font-size: 12px;
  line-height: 1.7;
  color: var(--text2);
}

.flag-red { color: #e05a4e; }
.flag-yellow { color: var(--yellow); }
.flag-green { color: var(--green); }

/* Competitor table */
.comp-table-wrap {
  overflow-x: auto;
  margin-bottom: 24px;
}
.comp-table {
  width: 100%;
  border-collapse: collapse;
  font-family: var(--mono);
  font-size: 12px;
}
.comp-table th {
  text-align: left;
  padding: 10px 14px;
  background: var(--bg3);
  color: var(--text3);
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
}
.comp-table td {
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  color: var(--text2);
  white-space: nowrap;
}
.comp-table tr:hover td { background: var(--bg3); }
.comp-table td.ticker-col { color: var(--gold); font-weight: 500; letter-spacing: 1px; }
.comp-table td.score-col { font-weight: 500; }
.comp-table td.high { color: var(--green); }
.comp-table td.mid { color: var(--yellow); }
.comp-table td.low { color: var(--red); }

/* Loading */
.loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px;
  gap: 20px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 2px solid var(--border);
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--text3);
  letter-spacing: 2px;
  text-transform: uppercase;
}

/* Error */
.error-msg {
  background: rgba(192,57,43,0.1);
  border: 1px solid rgba(192,57,43,0.3);
  border-radius: 4px;
  padding: 16px 20px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--red);
  margin: 20px 0;
}

/* Status bar */
.status-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  padding: 6px 32px;
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text3);
  letter-spacing: 0.5px;
  z-index: 200;
  display: flex;
  align-items: center;
  gap: 20px;
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--green);
  animation: pulse 2s ease-in-out infinite;
}
.status-dot.loading { background: var(--gold); }
.status-dot.error { background: var(--red); animation: none; }

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

/* Responsive */
@media (max-width: 900px) {
  .app { grid-template-columns: 1fr; }
  .sidebar { display: none; }
  .score-breakdown { grid-template-columns: 1fr; }
}

/* Tooltip */
.tooltip-wrap { position: relative; display: inline-block; }
.tooltip {
  position: absolute;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--mono);
  font-size: 10px;
  padding: 6px 10px;
  border-radius: 4px;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 1000;
}
.tooltip-wrap:hover .tooltip { opacity: 1; }

/* Fade-in animation */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in { animation: fadeIn 0.4s ease both; }

.add-watchlist-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--gold);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 1px;
  padding: 7px 14px;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.15s;
}
.add-watchlist-btn:hover { border-color: var(--gold); background: rgba(201,168,76,0.08); }

.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}
@media (max-width: 1100px) { .charts-grid { grid-template-columns: 1fr; } }

.comp-analyze-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--bg3);
  border: 1px solid var(--gold);
  color: var(--gold);
  font-family: var(--mono);
  font-size: 10px;
  letter-spacing: 1px;
  padding: 8px 16px;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.15s;
  margin-bottom: 20px;
  text-transform: uppercase;
}
.comp-analyze-btn:hover { background: rgba(201,168,76,0.1); }
.comp-analyze-btn:disabled { opacity: 0.4; cursor: not-allowed; }
</style>
</head>
<body>

<header class="header">
  <div class="logo">
    <span class="logo-title">Oracle Method</span>
    <span class="logo-sub">SEC ¬∑ EDGAR ¬∑ Buffett Intelligence</span>
  </div>
  <div class="header-right">
    <div class="search-bar">
      <input type="text" class="search-input" id="mainSearch" placeholder="TICKER" maxlength="10">
      <button class="search-btn" onclick="analyzeFromSearch()">ANALYZE</button>
    </div>
  </div>
</header>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Watchlist</div>
      <div class="watchlist-items" id="watchlistItems">
        <div class="wl-empty">No tickers added yet.</div>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Competitors</div>
      <div class="comp-add">
        <input type="text" class="comp-input" id="compInput" placeholder="TICKER" maxlength="8">
        <button class="comp-add-btn" onclick="addCompetitor()">+</button>
      </div>
      <div class="comp-list" id="compList"></div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-label">Legend</div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);display:flex;align-items:center;gap:8px;">
          <span style="color:var(--green)">‚óè</span> Score ‚â• 70 ‚Äî Strong
        </div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);display:flex;align-items:center;gap:8px;">
          <span style="color:var(--yellow)">‚óè</span> Score 40‚Äì69 ‚Äî Moderate
        </div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);display:flex;align-items:center;gap:8px;">
          <span style="color:var(--red)">‚óè</span> Score &lt; 40 ‚Äî Weak
        </div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text3);display:flex;align-items:center;gap:8px;">
          <span style="color:var(--red)">‚ö†</span> Debt YoY &gt; 20%
        </div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main" id="main">
    <div class="welcome fade-in">
      <div class="welcome-oracle">ORACLE</div>
      <div class="welcome-title">Buffett-Grade Stock Intelligence</div>
      <div class="welcome-sub">
        Enter any US public company ticker to analyze<br>
        10 years of SEC EDGAR financial data with AI scoring.<br><br>
        <span style="color:var(--text2)">AAPL ¬∑ BRK-B ¬∑ KO ¬∑ WMT ¬∑ JNJ ¬∑ MSFT</span>
      </div>
    </div>
  </main>
</div>

<div class="status-bar">
  <div class="status-dot" id="statusDot"></div>
  <span id="statusText">Ready ‚Äî SEC EDGAR connected</span>
  <span style="margin-left:auto;color:var(--text3)">Data: U.S. Securities and Exchange Commission EDGAR</span>
</div>

<script>
// =============================================
// STATE
// =============================================
let currentTicker = null;
let currentCIK = null;
let currentCompany = null;
let currentFinancials = null;
let watchlist = JSON.parse(localStorage.getItem('oracle_watchlist') || '[]');
let competitors = [];
let compData = {};

// =============================================
// STATUS BAR
// =============================================
function setStatus(msg, state = 'ok') {
  document.getElementById('statusText').textContent = msg;
  const dot = document.getElementById('statusDot');
  dot.className = 'status-dot' + (state === 'loading' ? ' loading' : state === 'error' ? ' error' : '');
}

// =============================================
// SEARCH
// =============================================
document.getElementById('mainSearch').addEventListener('keydown', e => {
  if (e.key === 'Enter') analyzeFromSearch();
});

async function analyzeFromSearch() {
  const raw = document.getElementById('mainSearch').value.trim().toUpperCase();
  if (!raw) return;
  await runAnalysis(raw);
}

// =============================================
// MAIN ANALYSIS
// =============================================
async function runAnalysis(ticker) {
  currentTicker = ticker;
  setStatus(`Resolving CIK for ${ticker}...`, 'loading');
  showLoading(`Fetching SEC data for ${ticker}...`);

  try {
    // Step 1: Resolve CIK
    const cik = await resolveCIK(ticker);
    if (!cik) throw new Error(`Could not resolve CIK for ticker: ${ticker}`);
    currentCIK = cik;

    setStatus(`CIK ${cik} resolved ‚Äî fetching financials...`, 'loading');

    // Step 2: Company facts
    const facts = await fetchCompanyFacts(cik);
    currentCompany = facts.entityName || ticker;

    setStatus(`Parsing 10-year financial history...`, 'loading');

    // Step 3: Parse financials
    const financials = parseFinancials(facts);
    currentFinancials = financials;

    // Step 4: Score
    const formulaScore = computeFormulaScore(financials);
    const aiScore = computeAIScore(financials, formulaScore);

    setStatus(`Fetching SEC filings...`, 'loading');

    // Step 5: Filings
    const filings = await fetchFilings(cik);

    setStatus(`Analysis complete for ${ticker}`, 'ok');

    // Step 6: Render
    renderAnalysis(ticker, cik, currentCompany, financials, formulaScore, aiScore, filings);

    // Save to watchlist
    updateWatchlistEntry(ticker, formulaScore, aiScore);

  } catch (err) {
    setStatus(`Error: ${err.message}`, 'error');
    showError(err.message);
  }
}

// =============================================
// CIK RESOLUTION
// =============================================
async function resolveCIK(ticker) {
  // Normalize: SEC uses BRK-B style, some users type BRK.B
  const t = ticker.toUpperCase().replace('.', '-');

  // Strategy 1: EDGAR company search API ‚Äî CORS-friendly, returns JSON
  // This is the official EDGAR full-text search, works from browsers
  try {
    const url = `https://efts.sec.gov/LATEST/search-index?q=%22${encodeURIComponent(t)}%22&dateRange=custom&startdt=2000-01-01&enddt=2099-12-31&forms=10-K`;
    const resp = await fetch(url);
    if (resp.ok) {
      const data = await resp.json();
      const hits = data.hits?.hits || [];
      for (const hit of hits) {
        // Check if ticker matches exactly in the entity_id or ticker field
        const src = hit._source || {};
        if (src.period_of_report && src.entity_id) {
          return String(src.entity_id).padStart(10, '0');
        }
      }
    }
  } catch(e) { console.warn('Strategy 1 failed:', e); }

  // Strategy 2: EDGAR company name/ticker search ‚Äî the most reliable CORS-safe endpoint
  try {
    const url = `https://efts.sec.gov/LATEST/search-index?q=%22${encodeURIComponent(t)}%22&forms=10-K`;
    const resp = await fetch(url);
    if (resp.ok) {
      const data = await resp.json();
      const hits = data.hits?.hits || [];
      if (hits.length > 0 && hits[0]._source?.entity_id) {
        return String(hits[0]._source.entity_id).padStart(10, '0');
      }
    }
  } catch(e) { console.warn('Strategy 2 failed:', e); }

  // Strategy 3: EDGAR company search by ticker via the submissions search
  // data.sec.gov is CORS-enabled for browser requests
  try {
    const url = `https://efts.sec.gov/LATEST/search-index?q=%22${encodeURIComponent(t)}%22`;
    const resp = await fetch(url);
    if (resp.ok) {
      const data = await resp.json();
      const hits = data.hits?.hits || [];
      if (hits.length > 0 && hits[0]._source?.entity_id) {
        return String(hits[0]._source.entity_id).padStart(10, '0');
      }
    }
  } catch(e) { console.warn('Strategy 3 failed:', e); }

  // Strategy 4: Use the EDGAR company search UI endpoint (JSON response, CORS-safe)
  try {
    const url = `https://www.sec.gov/cgi-bin/browse-edgar?company=&CIK=${encodeURIComponent(t)}&type=10-K&dateb=&owner=include&count=5&search_text=&action=getcompany&output=atom`;
    const resp = await fetch(url);
    if (resp.ok) {
      const text = await resp.text();
      // Parse CIK from Atom XML response
      const match = text.match(/CIK=(\d+)/i) || text.match(/<cik>(\d+)<\/cik>/i);
      if (match) return String(match[1]).padStart(10, '0');
    }
  } catch(e) { console.warn('Strategy 4 failed:', e); }

  // Strategy 5: Hardcoded map for most common tickers as reliable fallback
  const KNOWN_CIKS = {
    'AAPL':'0000320193','MSFT':'0000789019','GOOGL':'0001652044','GOOG':'0001652044',
    'AMZN':'0001018724','META':'0001326801','TSLA':'0001318605','NVDA':'0001045810',
    'BRK-B':'0001067983','BRK-A':'0001067983','JPM':'0000019617','JNJ':'0000200406',
    'V':'0001403161','UNH':'0000731766','WMT':'0000104169','XOM':'0000034088',
    'PG':'0000080424','MA':'0001141391','HD':'0000354950','CVX':'0000093410',
    'MRK':'0000310158','ABBV':'0001551152','PEP':'0000077476','KO':'0000021344',
    'COST':'0000909832','AVGO':'0001730168','MCD':'0000063754','CSCO':'0000858877',
    'ACN':'0001467373','TMO':'0000097745','ABT':'0000001800','DHR':'0000313616',
    'NEE':'0000753308','NKE':'0000320187','LIN':'0001707092','TXN':'0000097476',
    'VZ':'0000732712','CMCSA':'0001166691','QCOM':'0000804328','RTX':'0000101830',
    'HON':'0000773840','AMGN':'0000318154','IBM':'0000051143','GE':'0000040533',
    'CAT':'0000018230','ORCL':'0001341439','UPS':'0001090727','DE':'0000315189',
    'PM':'0001413329','MMM':'0000066740','BA':'0000012927','GS':'0000886982',
    'MS':'0000895421','BAC':'0000070858','WFC':'0000072971','C':'0000831001',
    'INTC':'0000050863','AMD':'0000002488','PYPL':'0001633917','ADBE':'0000796343',
    'CRM':'0001108524','NOW':'0001373715','SNOW':'0001640147','UBER':'0001543151',
    'LYFT':'0001759509','ABNB':'0001559720','SHOP':'0001594805','SQ':'0001512673',
    'ROKU':'0001428439','SPOT':'0001639920','NFLX':'0001065280','DIS':'0001001039',
    'SBUX':'0000829224','F':'0000037996','GM':'0001467858','RIVN':'0001874178',
    'LCID':'0001409375','LLY':'0000059478','PFE':'0000078003','MRNA':'0001682852',
    'BNTX':'0001776985','AZN':'0001310780','NVO':'0000353278','SNY':'0001121404',
  };

  const cik = KNOWN_CIKS[t] || KNOWN_CIKS[ticker.toUpperCase()];
  if (cik) return cik;

  throw new Error(
    `Could not resolve CIK for "${ticker}". ` +
    `This can happen due to browser CORS restrictions on SEC servers. ` +
    `Try: AAPL, MSFT, GOOGL, AMZN, KO, WMT, JNJ, BRK-B, TSLA, NVDA, NFLX, META.`
  );
}

// =============================================
// COMPANY FACTS
// =============================================
async function fetchCompanyFacts(cik) {
  const url = `https://data.sec.gov/api/xbrl/companyfacts/CIK${cik}.json`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error(`EDGAR facts not available (CIK: ${cik})`);
  return resp.json();
}

// =============================================
// PARSE FINANCIALS
// =============================================
function parseFinancials(facts) {
  const us = facts.facts?.['us-gaap'] || {};
  const dei = facts.facts?.['dei'] || {};

  function getAnnual(concept, unitKey = 'USD') {
    const obj = us[concept] || dei[concept] || {};
    const units = obj.units?.[unitKey] || [];
    // Filter 10-K annual filings
    const annual = units
      .filter(u => u.form === '10-K' && u.end)
      .map(u => ({ year: parseInt(u.end?.substring(0,4)), val: u.val, end: u.end, accn: u.accn }))
      .filter(u => u.year >= new Date().getFullYear() - 11 && u.year <= new Date().getFullYear());

    // Deduplicate: keep latest filing per year
    const byYear = {};
    annual.forEach(u => {
      if (!byYear[u.year] || u.end > byYear[u.year].end) byYear[u.year] = u;
    });
    return Object.values(byYear).sort((a,b) => a.year - b.year);
  }

  function getShares(concept) {
    return getAnnual(concept, 'shares');
  }

  // Revenue ‚Äî try multiple concepts
  const revenue = getAnnual('Revenues') || getAnnual('RevenueFromContractWithCustomerExcludingAssessedTax') || [];
  const revenue2 = getAnnual('SalesRevenueNet');
  const rev = revenue.length >= revenue2.length ? revenue : revenue2;

  const netIncome = getAnnual('NetIncomeLoss');
  const operatingCF = getAnnual('NetCashProvidedByUsedInOperatingActivities');
  const capex = getAnnual('PaymentsToAcquirePropertyPlantAndEquipment');
  const longTermDebt = getAnnual('LongTermDebt');
  const longTermDebt2 = getAnnual('LongTermDebtNoncurrent');
  const debt = longTermDebt.length >= longTermDebt2.length ? longTermDebt : longTermDebt2;
  const eps = getAnnual('EarningsPerShareBasic');
  const shares = getShares('CommonStockSharesOutstanding') || getShares('EntityCommonStockSharesOutstanding');
  const roe = getAnnual('ReturnOnEquity'); // often not directly in XBRL
  const equity = getAnnual('StockholdersEquity');
  const totalAssets = getAnnual('Assets');

  // Compute FCF = OperatingCF - Capex
  const fcf = operatingCF.map(cf => {
    const cx = capex.find(c => c.year === cf.year);
    return { year: cf.year, val: cf.val - (cx?.val || 0) };
  });

  // EPS computed if not available
  let epsData = eps;
  if (!epsData.length && netIncome.length && shares.length) {
    epsData = netIncome.map(ni => {
      const sh = shares.find(s => s.year === ni.year);
      return sh ? { year: ni.year, val: ni.val / sh.val } : null;
    }).filter(Boolean);
  }

  return {
    revenue: rev,
    netIncome,
    operatingCF,
    fcf,
    debt,
    eps: epsData,
    shares,
    equity,
    totalAssets,
    capex
  };
}

// =============================================
// FORMULA SCORE (Buffett-style)
// =============================================
function computeFormulaScore(fin) {
  let score = 0;
  let reasons = [];

  // 1. Revenue growth consistency (up to 20pts)
  if (fin.revenue.length >= 3) {
    const rev = fin.revenue.map(r => r.val);
    let growthYears = 0;
    for (let i = 1; i < rev.length; i++) {
      if (rev[i] > rev[i-1]) growthYears++;
    }
    const pct = growthYears / (rev.length - 1);
    const pts = Math.round(pct * 20);
    score += pts;
    reasons.push({ label: 'Revenue Growth Consistency', val: `${pts}/20`, cls: pts >= 14 ? 'good' : pts >= 8 ? 'warn' : 'bad' });
  }

  // 2. Net income consistency (up to 15pts)
  if (fin.netIncome.length >= 3) {
    const ni = fin.netIncome.map(r => r.val);
    let posYears = ni.filter(v => v > 0).length;
    const pts = Math.round((posYears / ni.length) * 15);
    score += pts;
    reasons.push({ label: 'Net Income Positivity', val: `${pts}/15`, cls: pts >= 11 ? 'good' : pts >= 7 ? 'warn' : 'bad' });
  }

  // 3. Debt trend (up to 15pts ‚Äî less is better)
  if (fin.debt.length >= 3) {
    const d = fin.debt.map(r => r.val);
    let debtIncreasing = 0;
    for (let i = 1; i < d.length; i++) {
      if (d[i] > d[i-1] * 1.1) debtIncreasing++;
    }
    const pts = Math.round(Math.max(0, 15 - (debtIncreasing / (d.length-1)) * 15));
    score += pts;
    reasons.push({ label: 'Debt Discipline', val: `${pts}/15`, cls: pts >= 10 ? 'good' : pts >= 6 ? 'warn' : 'bad' });
  }

  // 4. FCF generation (up to 15pts)
  if (fin.fcf.length >= 3) {
    const fcf = fin.fcf.filter(f => f.val > 0).length;
    const pts = Math.round((fcf / fin.fcf.length) * 15);
    score += pts;
    reasons.push({ label: 'Free Cash Flow Quality', val: `${pts}/15`, cls: pts >= 10 ? 'good' : pts >= 6 ? 'warn' : 'bad' });
  }

  // 5. Margin trend (up to 15pts)
  if (fin.netIncome.length >= 3 && fin.revenue.length >= 3) {
    const margins = fin.netIncome.map(ni => {
      const rev = fin.revenue.find(r => r.year === ni.year);
      return rev ? ni.val / rev.val : null;
    }).filter(Boolean);
    const avgMargin = margins.reduce((a,b) => a+b, 0) / margins.length;
    const pts = Math.min(15, Math.round(avgMargin * 100));
    score += Math.max(0, pts);
    reasons.push({ label: 'Net Profit Margin', val: `${pts}/15`, cls: pts >= 10 ? 'good' : pts >= 5 ? 'warn' : 'bad' });
  }

  // 6. Operating CF > Net Income (moat signal) (up to 10pts)
  if (fin.operatingCF.length >= 3 && fin.netIncome.length >= 3) {
    let cfExceedsNI = 0;
    fin.operatingCF.forEach(cf => {
      const ni = fin.netIncome.find(n => n.year === cf.year);
      if (ni && cf.val > ni.val && cf.val > 0) cfExceedsNI++;
    });
    const pts = Math.round((cfExceedsNI / fin.operatingCF.length) * 10);
    score += pts;
    reasons.push({ label: 'Cash vs Earnings Quality', val: `${pts}/10`, cls: pts >= 7 ? 'good' : pts >= 4 ? 'warn' : 'bad' });
  }

  // 7. EPS growth (up to 10pts)
  if (fin.eps.length >= 3) {
    const eps = fin.eps.map(e => e.val);
    const first = eps[0], last = eps[eps.length-1];
    if (first > 0 && last > 0) {
      const growth = (last / first) - 1;
      const pts = Math.min(10, Math.round(growth * 5));
      score += Math.max(0, pts);
      reasons.push({ label: 'EPS Growth (10yr)', val: `${pts}/10`, cls: pts >= 7 ? 'good' : pts >= 4 ? 'warn' : 'bad' });
    }
  }

  return { score: Math.min(100, Math.max(0, score)), reasons };
}

// =============================================
// AI ORACLE SCORE (heuristic + narrative)
// =============================================
function computeAIScore(fin, formulaResult) {
  const baseScore = formulaResult.score;
  // Add some nuance: adjust for data completeness
  const dataRichness = Math.min(1, (fin.revenue.length + fin.netIncome.length) / 20);
  const aiScore = Math.round(baseScore * 0.7 + baseScore * dataRichness * 0.3);

  // Generate narrative
  const rev = fin.revenue;
  const ni = fin.netIncome;
  const debt = fin.debt;
  const fcf = fin.fcf;

  let narrative = '';

  if (rev.length >= 2) {
    const revGrowth = ((rev[rev.length-1]?.val / rev[0]?.val) - 1) * 100;
    narrative += `Revenue has ${revGrowth > 0 ? 'grown' : 'declined'} ${Math.abs(revGrowth).toFixed(0)}% over ${rev.length} years. `;
  }

  if (ni.length >= 2) {
    const profitable = ni.filter(n => n.val > 0).length;
    narrative += `Net income was positive in ${profitable} of ${ni.length} reported annual periods. `;
  }

  if (debt.length >= 2) {
    const debtGrew = debt[debt.length-1]?.val > debt[0]?.val * 1.5;
    narrative += debtGrew
      ? '‚ö† Long-term debt has grown substantially ‚Äî warrants scrutiny on capital allocation. '
      : '‚úì Debt levels appear managed ‚Äî no alarming long-term debt acceleration. ';
  }

  if (fcf.length >= 2) {
    const positiveFCF = fcf.filter(f => f.val > 0).length;
    narrative += positiveFCF >= fcf.length * 0.8
      ? '‚úì Strong free cash flow generation ‚Äî hallmark of a durable business. '
      : '‚ö† Inconsistent free cash flow ‚Äî may signal capital intensity or margin pressure. ';
  }

  // Buffett verdict
  if (aiScore >= 70) {
    narrative += 'üü¢ Oracle Verdict: This company exhibits characteristics consistent with Buffett\'s criteria ‚Äî durable earnings, manageable debt, and consistent cash generation. Worth deeper study.';
  } else if (aiScore >= 45) {
    narrative += 'üü° Oracle Verdict: Mixed signals ‚Äî some Buffett-friendly traits present but offset by inconsistencies. Suitable for watchlist with caution.';
  } else {
    narrative += 'üî¥ Oracle Verdict: Does not currently meet Buffett\'s conservative criteria. High risk or cyclical business dynamics visible in the data.';
  }

  return { score: Math.min(100, Math.max(0, aiScore)), narrative };
}

// =============================================
// FETCH FILINGS
// =============================================
async function fetchFilings(cik) {
  try {
    const url = `https://data.sec.gov/submissions/CIK${cik}.json`;
    const resp = await fetch(url);
    const data = await resp.json();
    const recent = data.filings?.recent || {};
    const forms = recent.form || [];
    const dates = recent.filingDate || [];
    const accns = recent.accessionNumber || [];
    const descs = recent.primaryDocument || [];

    const wanted = ['10-K','10-Q','DEF 14A','8-K'];
    const result = [];

    for (let i = 0; i < forms.length && result.length < 30; i++) {
      const form = forms[i];
      const friendlyForm = wanted.find(w => form.startsWith(w.replace(' ','')));
      if (!friendlyForm && !wanted.includes(form)) continue;
      const accn = accns[i].replace(/-/g,'');
      result.push({
        form: forms[i],
        date: dates[i],
        accn: accns[i],
        url: `https://www.sec.gov/Archives/edgar/data/${parseInt(cik)}/${accn}/${descs[i] || ''}`,
        indexUrl: `https://www.sec.gov/cgi-bin/browse-edgar?action=getcompany&CIK=${cik}&type=${encodeURIComponent(forms[i])}&dateb=&owner=include&count=10`
      });
    }
    return result;
  } catch(e) {
    return [];
  }
}

// =============================================
// RENDER
// =============================================
function renderAnalysis(ticker, cik, company, fin, formulaResult, aiResult, filings) {
  const main = document.getElementById('main');
  const scoreClass = s => s >= 70 ? 'high' : s >= 40 ? 'mid' : 'low';

  main.innerHTML = `
    <div class="fade-in">
      <!-- Ticker Header -->
      <div class="ticker-header">
        <div>
          <div class="ticker-name">${ticker}</div>
          <div class="ticker-company">${company}</div>
          <div class="ticker-meta">CIK: ${cik} ¬∑ EDGAR ¬∑ 10-Year Analysis</div>
          <div style="margin-top:12px">
            <button class="add-watchlist-btn" onclick="addToWatchlist('${ticker}', ${formulaResult.score}, ${aiResult.score})">+ Add to Watchlist</button>
          </div>
        </div>
        <div class="score-cards">
          <div class="score-card">
            <div class="score-label">Formula Score</div>
            <div class="score-value ${scoreClass(formulaResult.score)}">${formulaResult.score}</div>
            <div class="score-bar"><div class="score-bar-fill" style="width:${formulaResult.score}%;background:${formulaResult.score>=70?'var(--green)':formulaResult.score>=40?'var(--yellow)':'var(--red)'}"></div></div>
          </div>
          <div class="score-card">
            <div class="score-label">AI Oracle</div>
            <div class="score-value ${scoreClass(aiResult.score)}">${aiResult.score}</div>
            <div class="score-bar"><div class="score-bar-fill" style="width:${aiResult.score}%;background:${aiResult.score>=70?'var(--green)':aiResult.score>=40?'var(--yellow)':'var(--red)'}"></div></div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="switchTab('overview', this)">Overview</div>
        <div class="tab" onclick="switchTab('charts', this)">10-Year Charts</div>
        <div class="tab" onclick="switchTab('competitors', this)">Competitors</div>
        <div class="tab" onclick="switchTab('filings', this)">SEC Filings</div>
      </div>

      <!-- OVERVIEW TAB -->
      <div class="tab-content active" id="tab-overview">
        ${renderMetrics(fin)}
        ${renderScoreBreakdown(formulaResult, aiResult)}
      </div>

      <!-- CHARTS TAB -->
      <div class="tab-content" id="tab-charts">
        <div class="charts-grid">
          ${renderBarChart('Revenue', fin.revenue, 'revenue', 'B')}
          ${renderBarChart('Net Income', fin.netIncome, 'income', 'B')}
          ${renderBarChart('Operating Cash Flow', fin.operatingCF, 'cashflow', 'B')}
          ${renderDebtChart(fin.debt)}
          ${renderBarChart('Free Cash Flow', fin.fcf, 'cashflow', 'B')}
          ${renderBarChart('EPS', fin.eps, 'income', '')}
        </div>
      </div>

      <!-- COMPETITORS TAB -->
      <div class="tab-content" id="tab-competitors">
        <button class="comp-analyze-btn" onclick="analyzeCompetitors()" id="compAnalyzeBtn">
          ‚ñ∂ Analyze ${competitors.length} Competitor(s)
        </button>
        <div id="compResults">
          <div style="font-family:var(--mono);font-size:11px;color:var(--text3);">
            Add competitor tickers in the sidebar, then click Analyze.
          </div>
        </div>
      </div>

      <!-- FILINGS TAB -->
      <div class="tab-content" id="tab-filings">
        <div class="section-title">Recent SEC Filings</div>
        ${renderFilings(filings, ticker)}
      </div>
    </div>
  `;
}

function renderMetrics(fin) {
  function latest(arr) { return arr?.length ? arr[arr.length-1] : null; }
  function fmt(val, scale='B') {
    if (val === null || val === undefined) return '‚Äî';
    if (scale === 'B') return (val/1e9).toFixed(2) + 'B';
    if (scale === 'M') return (val/1e6).toFixed(1) + 'M';
    if (scale === '') return val.toFixed(2);
    return val;
  }
  function trend(arr) {
    if (!arr || arr.length < 2) return { cls: 'flat', text: '‚Äî' };
    const pct = ((arr[arr.length-1].val / arr[arr.length-2].val) - 1) * 100;
    if (pct > 5) return { cls: 'up', text: `‚ñ≤ ${pct.toFixed(1)}% YoY` };
    if (pct < -5) return { cls: 'down', text: `‚ñº ${Math.abs(pct).toFixed(1)}% YoY` };
    return { cls: 'flat', text: `${pct.toFixed(1)}% YoY` };
  }

  const revL = latest(fin.revenue), niL = latest(fin.netIncome);
  const cfL = latest(fin.operatingCF), debtL = latest(fin.debt);
  const epsL = latest(fin.eps), sharesL = latest(fin.shares);
  const fcfL = latest(fin.fcf);

  const metrics = [
    { name: 'Revenue', val: fmt(revL?.val), ...trend(fin.revenue) },
    { name: 'Net Income', val: fmt(niL?.val), ...trend(fin.netIncome) },
    { name: 'Operating CF', val: fmt(cfL?.val), ...trend(fin.operatingCF) },
    { name: 'Free Cash Flow', val: fmt(fcfL?.val), ...trend(fin.fcf) },
    { name: 'Long-Term Debt', val: fmt(debtL?.val), ...trend(fin.debt) },
    { name: 'EPS', val: fmt(epsL?.val, ''), ...trend(fin.eps) },
    { name: 'Shares Out.', val: sharesL ? (sharesL.val/1e6).toFixed(0)+'M' : '‚Äî', cls:'flat', text:'‚Äî' },
    { name: 'Data Points', val: fin.revenue.length + ' years', cls:'flat', text:'' },
  ];

  return `
    <div class="section-title">Latest Financials</div>
    <div class="metrics-grid">
      ${metrics.map(m => `
        <div class="metric-card">
          <div class="metric-name">${m.name}</div>
          <div class="metric-val">${m.val}</div>
          ${m.text ? `<div class="metric-trend ${m.cls}">${m.text}</div>` : ''}
        </div>
      `).join('')}
    </div>
  `;
}

function renderScoreBreakdown(formulaResult, aiResult) {
  return `
    <div class="section-title">Score Analysis</div>
    <div class="score-breakdown">
      <div class="score-breakdown-card">
        <div class="score-breakdown-title">‚öô Formula Score Breakdown</div>
        ${formulaResult.reasons.map(r => `
          <div class="score-row">
            <span class="score-row-label">${r.label}</span>
            <span class="score-row-val ${r.cls}">${r.val}</span>
          </div>
        `).join('')}
        <div class="score-row" style="margin-top:8px;border-top:1px solid var(--gold);padding-top:12px;">
          <span class="score-row-label" style="font-weight:500;">Total Formula Score</span>
          <span class="score-row-val ${formulaResult.score>=70?'good':formulaResult.score>=40?'warn':'bad'}" style="font-size:16px;">${formulaResult.score}/100</span>
        </div>
      </div>

      <div class="score-breakdown-card">
        <div class="score-breakdown-title">üîÆ AI Oracle Judgment</div>
        <div class="ai-narrative">
          <div class="ai-narrative-title">Oracle Analysis</div>
          <div class="ai-narrative-text">${aiResult.narrative}</div>
        </div>
        <div class="score-row" style="border-top:1px solid var(--gold);padding-top:12px;margin-top:0">
          <span class="score-row-label" style="font-weight:500;">Oracle Score</span>
          <span class="score-row-val ${aiResult.score>=70?'good':aiResult.score>=40?'warn':'bad'}" style="font-size:16px;">${aiResult.score}/100</span>
        </div>
      </div>
    </div>
  `;
}

function renderBarChart(title, data, barClass, scale) {
  if (!data || data.length === 0) {
    return `<div class="chart-container"><div class="chart-title">${title}</div><div style="color:var(--text3);font-family:var(--mono);font-size:11px;">No data available</div></div>`;
  }

  const vals = data.map(d => d.val);
  const min = Math.min(...vals);
  const max = Math.max(...vals);
  const range = max - min || 1;

  function fmtVal(v) {
    if (scale === 'B') {
      if (Math.abs(v) >= 1e9) return (v/1e9).toFixed(1)+'B';
      if (Math.abs(v) >= 1e6) return (v/1e6).toFixed(0)+'M';
      return v.toFixed(0);
    }
    return v.toFixed(2);
  }

  const bars = data.map(d => {
    const isNeg = d.val < 0;
    const heightPct = Math.abs(d.val) / (Math.abs(min) + Math.abs(max) || 1) * 90;
    const bc = barClass === 'income' && d.val < 0 ? 'income negative' : barClass;
    return `
      <div class="bar-col">
        <div class="bar ${bc}" style="height:${Math.max(4,heightPct)}%" title="${d.year}: ${fmtVal(d.val)}">
          <div class="bar-val" style="top:-16px;">${fmtVal(d.val)}</div>
        </div>
        <div class="bar-label">${d.year}</div>
      </div>
    `;
  }).join('');

  return `
    <div class="chart-container">
      <div class="chart-title">${title} (Annual)</div>
      <div class="bar-chart">${bars}</div>
    </div>
  `;
}

function renderDebtChart(data) {
  if (!data || data.length === 0) {
    return `<div class="chart-container"><div class="chart-title">Long-Term Debt</div><div style="color:var(--text3);font-family:var(--mono);font-size:11px;">No data available</div></div>`;
  }

  const vals = data.map(d => d.val);
  const max = Math.max(...vals) || 1;

  // Flag years where debt grew >20% YoY
  const flaggedYears = new Set();
  for (let i = 1; i < data.length; i++) {
    if (data[i].val > data[i-1].val * 1.2) flaggedYears.add(data[i].year);
  }

  const hasFlagged = flaggedYears.size > 0;

  function fmtVal(v) {
    if (Math.abs(v) >= 1e9) return (v/1e9).toFixed(1)+'B';
    if (Math.abs(v) >= 1e6) return (v/1e6).toFixed(0)+'M';
    return v.toFixed(0);
  }

  const bars = data.map(d => {
    const heightPct = (d.val / max) * 90;
    const isFlagged = flaggedYears.has(d.year);
    return `
      <div class="bar-col" title="${d.year}: ${fmtVal(d.val)}${isFlagged?' ‚ö† >20% jump':''}">
        <div class="bar debt${isFlagged?' flagged':''}" style="height:${Math.max(4,heightPct)}%">
          <div class="bar-val">${fmtVal(d.val)}</div>
        </div>
        <div class="bar-label" style="${isFlagged?'color:var(--red)':''}">${d.year}</div>
      </div>
    `;
  }).join('');

  return `
    <div class="chart-container">
      <div class="chart-title">
        Long-Term Debt (Annual)
        ${hasFlagged ? `<span class="debt-flag">‚ö† DEBT SPIKE DETECTED</span>` : ''}
      </div>
      <div class="bar-chart">${bars}</div>
    </div>
  `;
}

function renderFilings(filings, ticker) {
  if (!filings.length) {
    return `<div class="error-msg">No recent filings found in EDGAR for ${ticker}.</div>`;
  }

  const typeClass = {
    '10-K': 'tenk',
    '10-Q': 'tenq',
    'DEF 14A': 'def14a',
    '8-K': 'eightk',
    'DEF14A': 'def14a',
  };

  return `
    <div class="filing-list">
      ${filings.map((f, i) => {
        const cls = typeClass[f.form] || 'eightk';
        const narrative = generateFilingNarrative(f.form, ticker);
        return `
          <div class="filing-item" onclick="toggleFiling(this)">
            <div class="filing-header">
              <span class="filing-type ${cls}">${f.form}</span>
              <span class="filing-desc">${filingDescription(f.form, ticker)}</span>
              <span class="filing-date">${f.date}</span>
              <a class="filing-link" href="${f.indexUrl}" target="_blank" onclick="e=>{e.stopPropagation();}">‚Üó EDGAR</a>
            </div>
            <div class="filing-narrative" style="display:none;">
              ${narrative}
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function toggleFiling(el) {
  const narr = el.querySelector('.filing-narrative');
  if (narr) narr.style.display = narr.style.display === 'none' ? 'block' : 'none';
}

function filingDescription(form, ticker) {
  const map = {
    '10-K': `Annual report ‚Äî comprehensive financials, risk factors, MD&A`,
    '10-Q': `Quarterly report ‚Äî unaudited interim financials`,
    'DEF 14A': `Proxy statement ‚Äî executive compensation, shareholder votes`,
    'DEF14A': `Proxy statement ‚Äî executive compensation, shareholder votes`,
    '8-K': `Current report ‚Äî material events, management changes, deals`,
  };
  return map[form] || `SEC filing ‚Äî ${form}`;
}

function generateFilingNarrative(form, ticker) {
  const narratives = {
    '10-K': `
      <span class="flag-green">üü¢ Revenue and operating metrics discussed in MD&A ‚Äî look for management commentary on margin sustainability.</span><br><br>
      <span class="flag-yellow">üü° Review the Critical Accounting Estimates section for changes in depreciation, amortization, or goodwill impairment methods ‚Äî these can mask earnings shifts.</span><br><br>
      <span class="flag-red">üî¥ Scan Risk Factors for litigation, regulatory exposure, and related-party transactions. Any mention of "material weakness" in internal controls is a serious red flag.</span><br><br>
      Key items to verify: auditor independence, executive compensation structure vs. performance, and share repurchase activity.
    `,
    '10-Q': `
      <span class="flag-green">üü¢ Interim financials provide early signal ‚Äî compare revenue run rate to prior-year quarters for trend accuracy.</span><br><br>
      <span class="flag-yellow">üü° Note any changes to segment reporting or restatements vs prior 10-Q. One-time items and restructuring charges deserve scrutiny.</span><br><br>
      <span class="flag-red">üî¥ Footnote 7 and beyond often contain related-party disclosures, covenant violations, and legal contingencies not highlighted in headlines.</span>
    `,
    'DEF 14A': `
      <span class="flag-yellow">üü° Executive compensation table ‚Äî verify CEO pay is tied to measurable performance, not just tenure or stock grants.</span><br><br>
      <span class="flag-red">üî¥ Related-party transactions section: loans to executives, consulting contracts with board members, or family employment relationships are Buffett red flags.</span><br><br>
      <span class="flag-green">üü¢ Insider ownership percentage is a positive signal ‚Äî skin in the game aligns management with shareholders.</span>
    `,
    'DEF14A': `
      <span class="flag-yellow">üü° Executive compensation table ‚Äî verify CEO pay is tied to measurable performance.</span><br><br>
      <span class="flag-red">üî¥ Related-party transactions: loans to executives or family employment are red flags.</span><br><br>
      <span class="flag-green">üü¢ High insider ownership aligns management with shareholders.</span>
    `,
    '8-K': `
      <span class="flag-yellow">üü° Management changes (Item 5.02) ‚Äî CEO/CFO turnover mid-cycle often precedes earnings surprises or guidance cuts.</span><br><br>
      <span class="flag-red">üî¥ Material agreements (Item 1.01) involving related parties or off-balance-sheet entities warrant deeper investigation.</span><br><br>
      <span class="flag-green">üü¢ Buyback authorizations and debt paydown announcements are constructive signals of management confidence.</span>
    `,
  };
  return narratives[form] || `<span class="flag-yellow">üü° Review this filing for material disclosures relevant to ${ticker}'s financial position.</span>`;
}

// =============================================
// COMPETITORS
// =============================================
function addCompetitor() {
  const input = document.getElementById('compInput');
  const ticker = input.value.trim().toUpperCase();
  if (!ticker || competitors.includes(ticker) || ticker === currentTicker) return;
  if (competitors.length >= 6) { alert('Max 6 competitors'); return; }
  competitors.push(ticker);
  input.value = '';
  renderCompTags();
  updateCompBtn();
}

document.getElementById('compInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') addCompetitor();
});

function removeCompetitor(ticker) {
  competitors = competitors.filter(t => t !== ticker);
  delete compData[ticker];
  renderCompTags();
  updateCompBtn();
}

function renderCompTags() {
  const list = document.getElementById('compList');
  list.innerHTML = competitors.map(t => `
    <div class="comp-tag">
      <span>${t}</span>
      <button class="comp-tag-remove" onclick="removeCompetitor('${t}')">√ó</button>
    </div>
  `).join('');
}

function updateCompBtn() {
  const btn = document.getElementById('compAnalyzeBtn');
  if (btn) btn.textContent = `‚ñ∂ Analyze ${competitors.length} Competitor(s)`;
}

async function analyzeCompetitors() {
  if (competitors.length === 0) { alert('Add competitors in the sidebar first.'); return; }
  const btn = document.getElementById('compAnalyzeBtn');
  btn.disabled = true;
  btn.textContent = 'Analyzing...';

  const results = [{ ticker: currentTicker, score: currentFinancials ? computeFormulaScore(currentFinancials) : null, ai: currentFinancials ? computeAIScore(currentFinancials, computeFormulaScore(currentFinancials)) : null, fin: currentFinancials, company: currentCompany }];

  for (const ticker of competitors) {
    try {
      setStatus(`Analyzing ${ticker}...`, 'loading');
      const cik = await resolveCIK(ticker);
      const facts = await fetchCompanyFacts(cik);
      const fin = parseFinancials(facts);
      const formula = computeFormulaScore(fin);
      const ai = computeAIScore(fin, formula);
      results.push({ ticker, score: formula, ai, fin, company: facts.entityName || ticker });
    } catch(e) {
      results.push({ ticker, score: null, ai: null, fin: null, company: ticker, error: e.message });
    }
  }

  setStatus('Competitor analysis complete', 'ok');
  renderCompetitorTable(results);
  btn.disabled = false;
  btn.textContent = `‚ñ∂ Re-Analyze ${competitors.length} Competitor(s)`;
}

function renderCompetitorTable(results) {
  const el = document.getElementById('compResults');

  function latest(arr) { return arr?.length ? arr[arr.length-1]?.val : null; }
  function fmtB(v) { if (v === null || v === undefined) return '‚Äî'; return (v/1e9).toFixed(2)+'B'; }
  function scoreClass(s) { if (s === null) return ''; return s >= 70 ? 'high' : s >= 40 ? 'mid' : 'low'; }

  el.innerHTML = `
    <div class="section-title">Competitor Comparison</div>
    <div class="comp-table-wrap">
      <table class="comp-table">
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Company</th>
            <th>Formula Score</th>
            <th>Oracle Score</th>
            <th>Revenue</th>
            <th>Net Income</th>
            <th>FCF</th>
            <th>LT Debt</th>
          </tr>
        </thead>
        <tbody>
          ${results.map(r => {
            const fs = r.score?.score ?? null;
            const as = r.ai?.score ?? null;
            return `
              <tr>
                <td class="ticker-col">${r.ticker}</td>
                <td>${r.company}</td>
                <td class="score-col ${scoreClass(fs)}">${fs !== null ? fs : r.error ? '‚ö† ERR' : '‚Äî'}</td>
                <td class="score-col ${scoreClass(as)}">${as !== null ? as : '‚Äî'}</td>
                <td>${r.fin ? fmtB(latest(r.fin.revenue)) : '‚Äî'}</td>
                <td>${r.fin ? fmtB(latest(r.fin.netIncome)) : '‚Äî'}</td>
                <td>${r.fin ? fmtB(latest(r.fin.fcf)) : '‚Äî'}</td>
                <td>${r.fin ? fmtB(latest(r.fin.debt)) : '‚Äî'}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// =============================================
// WATCHLIST
// =============================================
function addToWatchlist(ticker, formulaScore, aiScore) {
  const existing = watchlist.findIndex(w => w.ticker === ticker);
  const entry = { ticker, formulaScore, aiScore, addedAt: Date.now() };
  if (existing >= 0) watchlist[existing] = entry;
  else watchlist.unshift(entry);
  localStorage.setItem('oracle_watchlist', JSON.stringify(watchlist));
  renderWatchlist();
}

function updateWatchlistEntry(ticker, formulaResult, aiResult) {
  addToWatchlist(ticker, formulaResult.score, aiResult.score);
}

function renderWatchlist() {
  const el = document.getElementById('watchlistItems');
  if (!watchlist.length) {
    el.innerHTML = '<div class="wl-empty">No tickers added yet.</div>';
    return;
  }
  el.innerHTML = watchlist.map(w => `
    <div class="wl-item ${currentTicker === w.ticker ? 'active' : ''}" onclick="runAnalysis('${w.ticker}')">
      <div>
        <div class="wl-ticker">${w.ticker}</div>
        <div class="wl-score">F:${w.formulaScore} ¬∑ AI:${w.aiScore}</div>
      </div>
      <button class="wl-remove" onclick="event.stopPropagation();removeFromWatchlist('${w.ticker}')">√ó</button>
    </div>
  `).join('');
}

function removeFromWatchlist(ticker) {
  watchlist = watchlist.filter(w => w.ticker !== ticker);
  localStorage.setItem('oracle_watchlist', JSON.stringify(watchlist));
  renderWatchlist();
}

// =============================================
// TABS
// =============================================
function switchTab(id, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-' + id)?.classList.add('active');
}

// =============================================
// HELPERS
// =============================================
function showLoading(msg) {
  document.getElementById('main').innerHTML = `
    <div class="loading fade-in">
      <div class="loading-spinner"></div>
      <div class="loading-text">${msg}</div>
    </div>
  `;
}

function showError(msg) {
  const main = document.getElementById('main');
  const quickTickers = ['AAPL','MSFT','GOOGL','AMZN','KO','WMT','JNJ','BRK-B','TSLA','NVDA','NFLX','META','JPM','PG','V','COST','MCD','NKE','IBM','INTC'];
  const chips = quickTickers.map(t =>
    `<span onclick="document.getElementById('mainSearch').value='${t}';analyzeFromSearch();" style="cursor:pointer;font-family:var(--mono);font-size:11px;color:var(--gold);background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.25);padding:5px 12px;border-radius:3px;letter-spacing:1px;" onmouseover="this.style.background='rgba(201,168,76,0.18)'" onmouseout="this.style.background='rgba(201,168,76,0.08)'">${t}</span>`
  ).join('');
  main.innerHTML = `
    <div style="padding:32px;">
      <div class="error-msg">‚ö† ${msg}</div>
      <div style="margin-top:20px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:20px;">
        <div style="font-family:var(--mono);font-size:10px;letter-spacing:2px;color:var(--text3);margin-bottom:14px;text-transform:uppercase;">Click a ticker to try</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">${chips}</div>
      </div>
    </div>
  `;
}

// =============================================
// INIT
// =============================================
renderWatchlist();

// Keyboard shortcut: / to focus search
document.addEventListener('keydown', e => {
  if (e.key === '/' && document.activeElement.tagName !== 'INPUT') {
    e.preventDefault();
    document.getElementById('mainSearch').focus();
  }
});
</script>
</body>
</html>
